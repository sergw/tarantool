test_run = require('test_run').new()
---
...
test_run:create_cluster(CLUSTER, 'promote')
---
...
test_run:wait_fullmesh(CLUSTER)
---
...
--
-- Check the promote actually allows to switch the master.
--
test_run:switch('box1')
---
- true
...
-- Box1 is a master.
box.cfg.read_only
---
- false
...
test_run:switch('box2')
---
- true
...
-- Box2 is a slave.
box.cfg.read_only
---
- true
...
-- And can not do DDL/DML.
box.schema.create_space('test') -- Fail.
---
- error: Can't modify data because this instance is in read-only mode.
...
box.ctl.promote()
---
- true
...
-- Now the slave has become a master.
box.cfg.read_only
---
- false
...
-- And can do DDL/DML.
s = box.schema.create_space('test')
---
...
s:drop()
---
...
test_run:switch('box1')
---
- true
...
-- In turn, the old master is a slave now.
box.cfg.read_only
---
- true
...
-- For him any DDL/DML is forbidden.
box.schema.create_space('test2')
---
- error: Can't modify data because this instance is in read-only mode.
...
--
-- Check promotion history.
--
test_run:switch('box2')
---
- true
...
promotion_history()
---
- - {'step': 1, 'value': {'timeout': 3153600000, 'quorum': 4}, 'id': 1, 'type': 'begin',
    'source_uuid': 'box2', 'round_uuid': 'round_1'}
  - {'step': 2, 'value': {'is_master': true}, 'id': 1, 'type': 'status', 'source_uuid': 'box1',
    'round_uuid': 'round_1'}
  - {'step': 2, 'value': {'is_master': false}, 'id': 1, 'type': 'status', 'source_uuid': 'box3',
    'round_uuid': 'round_1'}
  - {'step': 2, 'value': {'is_master': false}, 'id': 1, 'type': 'status', 'source_uuid': 'box4',
    'round_uuid': 'round_1'}
  - {'step': 3, 'id': 1, 'type': 'sync', 'source_uuid': 'box1', 'round_uuid': 'round_1'}
  - {'step': 4, 'id': 1, 'type': 'success', 'source_uuid': 'box2', 'round_uuid': 'round_1'}
  - {'step': 4, 'id': 1, 'type': 'success', 'source_uuid': 'box3', 'round_uuid': 'round_1'}
  - {'step': 4, 'id': 1, 'type': 'success', 'source_uuid': 'box4', 'round_uuid': 'round_1'}
  - {'step': 5, 'id': 1, 'type': 'success', 'source_uuid': 'box1', 'round_uuid': 'round_1'}
...
test_run:switch('default')
---
- true
...
test_run:drop_cluster(CLUSTER)
---
...
